
/**
 * Created by XuanHen on 2016/10/22.
 * Object by 花镇
 * V0.4  2017年03月24日10:45:00
 * 1. 增加唯一识别码
 * 2. 增加传值列表
 * 3. 兼容旧版
 * V0.3  2017年03月23日15:13:53
 * 增加弹窗按钮点击后事件
 */





var Submit = function (obj,params) {

    var codess = 1;
    var defaults = {
        popup : '.popup',           //弹窗
        popupHind : '.popup-hind',  //弹窗提示
        popupBtn : '.popup-btn',    //弹窗按钮
        popupAnimation : 'fade',    //效果
        popupEnd : function(){},    // 弹窗点击后的回调函数
        data : {   //传值列表
            name : 'realname',              //姓名
            mobile : 'mobile',              //手机号
            gender : 'gender',              //性别   2:女 1:男 0:未知
            question : 'question',          //需求类型
            hope : 'hope',                  //期望
            render_time : 'render_time',    //服务提供时间
            channel : 'channel',            //意向单
            channel_code : 'channel_code',  //意向单唯一识别码
            time : 'consult_time',          //时间  1 上午 2 中午 3 下午
            code : 'verify_code'            //验证码
        },
        code : '.code-btn',                 //验证码按钮
        submit : '.submit-btn',             //提交按钮
        submitSuccess : function () {},     //提交成功的回调函数
        submitError : function () {},       //提交失败的回调函数
        channel : '',              //意向单
        channel_code : '',      // 意向单唯一识别码
        dataUrl : 'http://pr.api.huazhen2008.com/v1/guest_issues.php'
    };
    params = params || {};

    //初始化
    for(var param in params){
        if(params[param]){
            defaults[param] = params[param];
        }
    };

    // 子类参数
    this.submitRight = false;   // 是否提交成功

    //添加默认属性
    var popupAnimationIn = defaults.popupAnimation+'In';
    var popupAnimationOut = defaults.popupAnimation+'Out';

    var name,mobile,gender,question,hope,channel,time,code;

    //显示动画
    function AddIn(obj,OldClass,NewClass){
        $(obj).show().removeClass(OldClass).addClass(NewClass);
    };

    //隐藏动画
    function AddOut(obj,OldClass,NewClass){
        $(obj).removeClass(OldClass).addClass(NewClass);
        setTimeout(function () {
            $(obj).hide();
        },1000);
    };

    //弹出提示框
    function popupShow(Text){
        $(defaults.popupHind).text(Text);
        AddIn(defaults.popup,popupAnimationOut,popupAnimationIn);
    }

    this.popupShow = function (Text){
        $(defaults.popupHind).text(Text);
        AddIn(defaults.popup,popupAnimationOut,popupAnimationIn);
    }

    //验证姓名
    function ValiDateName(name) {
        if (name.length < 2 || name.length > 20) {
            popupShow('请输入正确的姓名哦，亲~');
            return false;
        }
        return true;
    }

    //验证手机号码正确性
    function ValiDateMobile(mobile) {
        var myreg = /^(((13[0-9]{1})|(15[0-9]{1})|(18[0-9]{1})|(17[0-9]{1}))+\d{8})$/;
        if (!myreg.test(mobile)) {
            popupShow('请输入正确的11位数字的手机号码哦，亲~');
            return false;
        }
        return true;
    }

    //验证选择
    function ValiDateSelect(Select){
        if(Select.hasClass('active')){
            return true;
        }else{
            popupShow('请选择您要咨询的问题哦，亲~');
            return false;
        }
    }
    function ValiCode(code){
        popupShow('请输入正确验证码哦，亲~');
    }
    var codeFlag = true; //验证码按钮有无点击
    //获取验证码
    function ValiDateCode() {
        if(codeFlag){
            codeFlag = false;
            mobile = $(obj+' input[name=mobile]').val();
            if (ValiDateMobile(mobile)) {
                //取消事件
                $(obj).off('click',defaults.code);

                //变成不可点击样式
                $(defaults.code).css({
                    color : 'white',
                    background : '#DD9898'
                });

                var Times = 59;
                var TextTime = setInterval(function () {
                    if (Times <= 0) {
                        clearInterval(TextTime);
                        $(obj+' '+defaults.code).text("重新获取").attr('style','');
                        codeFlag = true;
                        $('.info-code-btn').on('click', function () {
                            ValiDateCode(code);
                        });
                        return;
                    }
                    $(obj+' '+defaults.code).text(Times);
                    Times--;
                }, 1000);

                $.ajax({
                    type: "post",
                    url: "http://pr.api.huazhen2008.com/v1/send_verify_code.php",
                    dataType: 'json',
                    data: "mobile=" + mobile,
                    success:function(msg){
                        if (msg.status == -1) {
                            popupShow(msg.msg);
                            return false;
                        }
                        codess = msg['code'];
                    },
                    error: function () {
                        popupShow('提交失败，请稍后重试~');
                    }
                });

            }else{
              codeFlag = true;
            }
        }
    }

    //选择项
    function ClickSelect(Select){
        $(obj).on('click',Select,function (event) {
            event.stopPropagation();
            $(this).siblings().removeClass('active');
            $(this).toggleClass('active');
        })
    }

    //验证有无该输入选项
    function JudegHaveInput(obj,Function){
        if(obj.length > 0){
            return Function(obj.val());
        }
        return true;
    }
    //验证有无该选择项
    function JudegHaveSelect(obj,Function){
        if(obj.length > 0){
            return Function(obj);
        }
        return true;
    }
    function JudegHaveCode(obj,Function){
        console.log($(obj))
        console.log(codess)
        if(obj.val() != codess){
            return Function(obj);
        }
        return true;
    }

    //弹窗点击消失
    $(document).on('click',defaults.popupBtn,function () {
        AddOut(defaults.popup,'fadeIn','fadeOut');
        defaults.popupEnd();
    });

    //提交按钮
    $(obj+' .submit-btn').on('click',function () {
        if($(obj+' input[name=verify_code]').length>0){
            if($(obj+' input[name=verify_code]').val() == codess){
                subcli();
            }else{
                popupShow('请输入正确的验证码哦，亲~');
            }
        }else{
           subcli(); 
       }
            
    });
    function subcli(){
        if(JudegHaveInput($(obj+' input[name=realname]'),ValiDateName)
                && JudegHaveInput($(obj+' input[name=mobile]'),ValiDateMobile)
                && JudegHaveSelect($(obj+' *[name=gender]'),ValiDateSelect)
                && JudegHaveSelect($(obj+' *[name=question]'),ValiDateSelect)
                && JudegHaveSelect($(obj+' *[name=hope]'),ValiDateSelect)
                && JudegHaveSelect($(obj+' *[name=time]'),ValiDateSelect)) {

                name = $(obj + ' input[name=realname]').val();
                mobile = $(obj + ' input[name=mobile]').val();
                code = $(obj + ' input[name=code]').val();
                gender = $(obj + ' *[name=gender].active').attr('value');
                hope = $(obj + ' *[name=hope].active').attr('value');
                question = $(obj + ' *[name=question].active').attr('value');
                time = $(obj + ' *[name=time].active').attr('value');
                render_time = $(obj + ' *[name=render_time].active').attr('value');

                var Data = 'realname=' + name + '&mobile=' + mobile + '&gender=' + gender + '&hope=' + hope + '&question=' + question + "&channel=" + defaults.channel + "&channel_code=" + defaults.channel_code + '&consult_time=' + time + '&verify_code=' + code + '&render_time=' + render_time;
                // 删除没有的字段 和 空的字段
                Data = Data.replace(/[a-z|A-Z|_]*=(undefined&|&)/ig,'');
                console.log($(obj))
                $.ajax({
                    url: 'http://api.junzhinuo1314.com/api/newWillInput',
                    type: 'post',
                    data: Data,
                    success: function (data) {
                        // if(typeof data === 'string'){
                        //     data = JSON.parse(data);
                        // }
                        // popupShow('资源已存在~');
                        if(data.status == 1){
                            popupShow('您的信息已提交，请耐心等待客服联系您哦~');
                        }else {
                            if(data.msg == '资源已经存在!'){
                                popupShow('您已经提交过，无需再提交~');
                            }else{
                                popupShow('您的预约咨询提交成功!');
                            }
                        }
                        defaults.submitSuccess(data,codess);
                    },
                    error: function () {
                        defaults.submitError();
                    }
                });
            }
    }
    //验证码点击事件
    $(obj+' .code-btn').on('click',function () {ValiDateCode();});

    //初始化
    function init() {
        ClickSelect('*[name=gender]');
        ClickSelect('*[name=question]');
        ClickSelect('*[name=hope]');
        ClickSelect('*[name=time]');
    }

    init();
};
